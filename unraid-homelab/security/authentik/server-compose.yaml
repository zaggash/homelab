services:
  authentik-server:
    container_name: authentik-server
    image: ghcr.io/goauthentik/server:2024.2.3@sha256:07a07c26552fe777500700d0d3f2c9ba6d63dad3e81982f9e8232d5c6db44116
    command: server
    labels:
      traefik.enable: true
      traefik.docker.network: proxy
      traefik.http.routers.authentik.rule: Host(`authentik.${SECRET_DOMAIN}`)
      traefik.http.routers.authentik.entryPoints: websecure
      traefik.http.services.authentik.loadbalancer.server.port: 9000
      traefik.http.services.authentik.loadbalancer.server.scheme: http
    networks:
      - proxy
      - authentik-db
      - authentik
    volumes:
      - "${SECRET_APPDATA}/authentik/media:/media"
    environment:
      AUTHENTIK_SECRET_KEY: ${SECRET_AUTHENTIK_SECRET_KEY}
      AUTHENTIK_REDIS__HOST: authentik-redis
      AUTHENTIK_POSTGRESQL__HOST: authentik-pg
      AUTHENTIK_POSTGRESQL__USER: ${SECRET_AUTHENTIK_DB_USERNAME}
      AUTHENTIK_POSTGRESQL__NAME: ${SECRET_AUTHENTIK_DB_DATABASE_NAME}
      AUTHENTIK_POSTGRESQL__PASSWORD: ${SECRET_AUTHENTIK_DB_PASSWORD}
      AUTHENTIK_EMAIL__HOST: ${SECRET_OVH_SMTP_HOST}
      AUTHENTIK_EMAIL__PORT: 465
      AUTHENTIK_EMAIL__USERNAME: ${SECRET_OVH_SMTP_USERNAME}
      AUTHENTIK_EMAIL__PASSWORD: ${SECRET_OVH_SMTP_PASSWORD}
      AUTHENTIK_EMAIL__USE_TLS: false
      AUTHENTIK_EMAIL__USE_SSL: true
      AUTHENTIK_EMAIL__TIMEOUT: 5
      AUTHENTIK_EMAIL__FROM: Authentik <authentik@${SECRET_DOMAIN}>
    restart: always
