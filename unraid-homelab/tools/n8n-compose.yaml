services:
  n8n:
    container_name: n8n
    image: ghcr.io/n8n-io/n8n:1.117.0@sha256:7b0d7d7499b2d0a472364b772267f9807a6c445753537435c51eb7736399a3b4
    labels:
      folder.view2: Tools
      net.unraid.docker.icon: ${SECRET_APPDATA}/icons/n8n.png
      traefik.enable: true
      traefik.docker.network: homelab_tools
      traefik.http.routers.n8n.rule: Host(`flow.${SECRET_DOMAIN}`)
      traefik.http.routers.n8n.entryPoints: websecure
      traefik.http.services.n8n.loadbalancer.server.port: 5678
    volumes:
      - "${SECRET_APPDATA}/n8n/data:/home/node/.n8n"
    environment:
      TZ: ${TZ}
      GENERIC_TIMEZONE: ${TZ}
      N8N_ENFORCE_SETTINGS_FILE_PERMISSIONS: true
      N8N_HOST: flow.${SECRET_DOMAIN}
      N8N_PORT: 5678
      N8N_RUNNERS_ENABLED: true
      NODE_ENV: production
      WEBHOOK_URL: https://flow.${SECRET_DOMAIN}
      N8N_COMMUNITY_PACKAGES_ALLOW_TOOL_USAGE: true
      DB_SQLITE_POOL_SIZE: 20
      N8N_SMTP_HOST: ${SECRET_OVH_SMTP_HOST}
      N8N_SMTP_PORT: 465
      N8N_SMTP_USER: ${SECRET_OVH_SMTP_USERNAME}
      N8N_SMTP_PASS: ${SECRET_OVH_SMTP_PASSWORD}
      N8N_SMTP_SENDER: n8n@${SECRET_DOMAIN}
    networks:
      - tools
    restart: always

networks:
  tools:
