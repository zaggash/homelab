version: "3"

services:
  pihole: &backup_service
    image: offen/docker-volume-backup:v2.25.1@sha256:1bb1e4aa293705996b796c9a0593f3c14f771ad2ea2dd329d6520e15149ae44d
    restart: always
    dns:
      - 192.168.1.10
    environment: &backup_env
      AWS_ENDPOINT: "s3.home.lan:9000"
      AWS_ENDPOINT_PROTO: "https"
      AWS_ENDPOINT_INSECURE: "true"
      AWS_ACCESS_KEY_ID: "docker-volumes-backup"
      AWS_SECRET_ACCESS_KEY: "6WxsAak2WvalbrvlcZQEAhka814_jeEWpSD8wp6nCZ05Mr3R"
      AWS_S3_BUCKET_NAME: "docker-volumes-backup"
      AWS_S3_PATH: "/pihole"
      BACKUP_FILENAME: "pihole-%Y-%m-%dT%H-%M-%S.tar.gz"
      BACKUP_EXCLUDE_REGEXP: "(/.*pihole-FTL.db.*$$)|(/.*metrics.interim$$)"
      BACKUP_CRON_EXPRESSION: "0 4 * * *"
      BACKUP_RETENTION_DAYS: "14"
      BACKUP_PRUNING_PREFIX: "pihole-"
      NOTIFICATION_URLS: "discord://rVJD7O_aNF0LGC6Uznt1rSVDRhbE-9v21IAS7bQYmTt4zPZHeCHQ1-nb9YFnaT9IRLNL@1039948185994539118"
      NOTIFICATION_LEVEL: "error"
    volumes:
      - "pihole_data:/backup/pihole/data:ro"
      - "pihole_dnsmasq:/backup/pihole/dnsmasq:ro"
      
  unifi:
    <<: *backup_service
    environment:
      <<: *backup_env
      AWS_S3_PATH: "/unifi"
      BACKUP_FILENAME: "unifi-%Y-%m-%dT%H-%M-%S.tar.gz"
      BACKUP_CRON_EXPRESSION: "0 5 * * *"
      BACKUP_RETENTION_DAYS: "14"
      BACKUP_PRUNING_PREFIX: "unifi-"
    volumes:
      - "unifi_data:/backup/unifi/data"

volumes:
  pihole_data:
    external: true
  pihole_dnsmasq:
    external: true
  unifi_data:
    external: true
